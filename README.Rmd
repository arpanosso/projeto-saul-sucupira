---
title: "Projeto Sucupira / An√°lise de Dados"
date: "`r Sys.Date()`"
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  comment = "#>"
)
```

## üë®‚Äçüî¨ Autores

-   **Regivam Antonio de Saul**\
    Graduando em Agronomia - FEIS/Unesp\
    Email: [regivan.saul\@unesp.br](mailto:regivan.saul@unesp.br)

-   **Wit√≥ria de Oliveira Araujo**\
    P√≥s-graduando em Agronomia - FCAV/Unesp\
    Email: [witoria.araujo\@unesp.br](mailto:witoria.araujo@unesp.br)
    
-   **Rodrigo Baratiere Perim**\
    P√≥s-graduando em Agronomia - FCAV/Unesp\
    Email: [rodrigo.perim\@unesp.br](mailto:rodrigo.perim@unesp.br)

-   **Prof. Dr. Alan Rodrigo Panosso**\
    Coorientador ‚Äî Departamento de Ci√™ncias Exatas - FCAV/Unesp\
    Email: [alan.panosso\@unesp.br](mailto:alan.panosso@unesp.br)
    
-   **Prof. Dr. Mario Luiz Teixeira de Moraes**\
    Coorientador ‚Äî Departamento de Fitotecnia, Tecnologia de Alimentos e S√≥cio-Economia - FEIS/Unesp\
    Email: [ mario.moraes\@unesp.br](mailto: mario.moraes@unesp.br)
    

### Carregando Pacotes

```{r}
library(tidyverse)
library(corrplot)
library(spdep)
library(gstat)
library(vegan)
library(sf)
library(sp)
source("R/my-functions.R")
```


### Carregando os banco de dados

```{r}
lsgo<-readxl::read_xlsx("data-raw/GO-LAG-Pop-Sucupira1.xlsx") |> 
  janitor::clean_names()
selms<-readxl::read_xlsx("data-raw/MS-SEL-Pop-Sucupira1.xlsx") |> 
  janitor::clean_names()
aposp<-readxl::read_xlsx("data-raw/SP-APO-Pop-Sucupira1.xlsx") |> 
  janitor::clean_names()

# altera√ß√£o do sistema de coordenadas
data_set <- rbind(lsgo,selms,aposp) |> 
  # st_as_sf(coords = c("easting", "northing"),
  #          crs = 31983) %>%      # CRS de origem
  # st_transform(crs = 4326) %>%   # WGS84 (lat/long)
  mutate(
    longitude = easting,
    latitude = northing
    # longitude = st_coordinates(.)[,1],
    # latitude  = st_coordinates(.)[,2]
  ) #%>%
  # st_drop_geometry()
```

### Grid amostral e Gr√°ficos


Os gr√°ficos X‚ÄìY com gradiente de cor foram utilizados para representar a
distribui√ß√£o espacial das vari√°veis dentro de cada popula√ß√£o, por padr√£o utilizamos 3 classes por popula√ß√£o, em que a tonalidade indica a magnitude dos valores observados. Essa abordagem permite identificar visualmente gradientes espaciais, manchas e poss√≠veis padr√µes de agrega√ß√£o ou heterogeneidade intra-populacional.

Os boxplots foram empregados para comparar a distribui√ß√£o das vari√°veis entre popula√ß√µes, evidenciando diferen√ßas de mediana, dispers√£o e presen√ßa de valores extremos. 

Em conjunto, essas visualiza√ß√µes auxiliam na interpreta√ß√£o dos resultados de correla√ß√£o e autocorrela√ß√£o espacial, bem como na identifica√ß√£o de padr√µes relevantes para an√°lises estat√≠sticas subsequentes.


```{r}
names_vari <- names(data_set |> select(hc_m:s_enxofre))
walk(names_vari,~{
  plot_map <- data_set |>
    select(populacao,longitude,latitude,!!sym(.x)) |>
    group_by(populacao) |>
    mutate(
      classe = cut(!!sym(.x),3)
    ) |>
    ggplot(aes(x=longitude, y=latitude,colour = classe)) +
    geom_point() +
    facet_wrap(~populacao,scale="free",ncol=2)+
    theme_bw()+
    labs(
      colour = .x
    )
  
    plot_box <- data_set |> 
    select(populacao,longitude,latitude,!!sym(.x)) |> 
    group_by(populacao) |> 
    ggplot(aes(y=!!sym(.x), fill = populacao)) +
    geom_boxplot() +
    theme_bw()+
    labs(
      fill = "populacao"
    ) + scale_fill_viridis_d(option = "B")
    
    print(plot_map)
    print(plot_box)
})

```

### Estat√≠stica Descritiva

A estat√≠stica descritiva foi utilizada para caracterizar a distribui√ß√£o das vari√°veis analisadas em cada popula√ß√£o, incluindo medidas de posi√ß√£o e dispers√£o, bem como os coeficientes de assimetria e curtose.

O coeficiente de assimetria permite avaliar desvios em rela√ß√£o √† simetria da distribui√ß√£o, indicando predomin√¢ncia de valores mais altos ou mais baixos. A curtose descreve o grau de concentra√ß√£o dos dados em torno da m√©dia, auxiliando na identifica√ß√£o de distribui√ß√µes mais achatadas ou mais concentradas.


```{r}
data_set |> 
  select(populacao, hc_m:s_enxofre) |> 
  group_by(populacao) |> 
  reframe( across(
    .cols = hc_m:s_enxofre,
    .fns = estat_desc,
    .names = "{.col}"
  )) |>
  ungroup() |> 
  add_column(estat = rep(estat_names,3)) |> 
  relocate(estat) |> 
  writexl::write_xlsx("output/estatistica-descritiva.xlsx")
```


### Correla√ß√£o linear por popula√ß√£o

A an√°lise de correla√ß√£o linear foi realizada separadamente para cada popula√ß√£o, com o objetivo de avaliar as rela√ß√µes entre as vari√°veis dentro de um mesmo contexto ambiental e espacial, evitando efeitos de confus√£o associados √†s diferen√ßas entre localidades.

As matrizes de correla√ß√£o foram visualizadas por meio de corrplot, permitindo identificar a dire√ß√£o (positiva ou negativa) e a intensidade das correla√ß√µes entre vari√°veis, bem como padr√µes consistentes ou contrastantes entre as popula√ß√µes analisadas.

Ideal para interpreta√ß√£o  das rela√ß√µes planta‚Äìsolo em n√≠vel intra-populacional.

```{r}
data_set |> 
  filter(populacao == "Lagoa Santa/GO") |> 
  select(hc_m:s_enxofre) |> 
  cor(use = "complete.obs") |> 
  corrplot::corrplot( method = "color",
         outline = T,,
         addgrid.col = "darkgray",cl.pos = "r", tl.col = "black",
         tl.cex = 1, cl.cex = 1, type = "upper", bg="azure2",
         diag = FALSE,
         # addCoef.col = "black",
         cl.ratio = 0.2,
         cl.length = 5,
         number.cex = 0.8)
```
### Correla√ß√£o linear - por popula√ß√£o
```{r}
data_set |> 
  filter(populacao == "Selv√≠ria/MS") |> 
  select(hc_m:s_enxofre) |> 
  cor(use = "complete.obs") |> 
  corrplot::corrplot( method = "color",
         outline = T,,
         addgrid.col = "darkgray",cl.pos = "r", tl.col = "black",
         tl.cex = 1, cl.cex = 1, type = "upper", bg="azure2",
         diag = FALSE,
         # addCoef.col = "black",
         cl.ratio = 0.2,
         cl.length = 5,
         number.cex = 0.8)
```
### Correla√ß√£o linear
```{r}
data_set |> 
  filter(populacao == "Aparecida D'Oeste/SP") |> 
  select(hc_m:s_enxofre) |> 
  cor(use = "complete.obs") |> 
  corrplot::corrplot( method = "color",
         outline = T,,
         addgrid.col = "darkgray",cl.pos = "r", tl.col = "black",
         tl.cex = 1, cl.cex = 1, type = "upper", bg="azure2",
         diag = FALSE,
         # addCoef.col = "black",
         cl.ratio = 0.2,
         cl.length = 5,
         number.cex = 0.8)
```

### Autocorrela√ß√£o espacial (Moran‚Äôs I)

O √çndice de Moran √© uma medida de autocorrela√ß√£o espacial global que avalia  se valores de uma vari√°vel observados em pontos pr√≥ximos no espa√ßo tendem  a ser mais semelhantes (autocorrela√ß√£o positiva), mais diferentes (autocorrela√ß√£o negativa) ou distribu√≠dos aleatoriamente.

**Valores de Moran‚Äôs I pr√≥ximos ao valor esperado sob aleatoriedade indicam aus√™ncia de estrutura espacial. Valores significativamente maiores que o esperado indicam autocorrela√ß√£o espacial positiva (agrega√ß√£o), enquanto  valores menores indicam autocorrela√ß√£o negativa (repuls√£o).**

A signific√¢ncia estat√≠stica √© avaliada por teste de randomiza√ß√£o. Um p-valor baixo (ex.: p < 0,05) indica que o padr√£o espacial observado difere do acaso, na escala definida pela matriz de vizinhan√ßa utilizada.

```{r}
coords <- data_set  |> 
  filter(populacao == "Lagoa Santa/GO")  |>  
  select(longitude, latitude)

nb <- dnearneigh(as.matrix(coords), 5, 300)  # ajuste dist√¢ncia
lw <- nb2listw(nb, style = "W")

walk(names_vari, ~{
  x <- data_set |> filter(populacao == "Lagoa Santa/GO")|> pull(!!sym(.x))
  x[is.na(x)] <- mean(x,na.rm=TRUE) 
  print(paste0("|---------- ",.x," ---------|"))
  print(moran.test(x, lw))
  
})
```

```{r}
coords <- data_set  |> 
  filter(populacao == "Selv√≠ria/MS")  |>  
  select(longitude, latitude)

nb <- dnearneigh(as.matrix(coords), 5, 500)  # ajuste dist√¢ncia
lw <- nb2listw(nb, style = "W")

walk(names_vari, ~{
  x <- data_set |> filter(populacao == "Selv√≠ria/MS")|> pull(!!sym(.x))
  x[is.na(x)] <- mean(x,na.rm=TRUE) 
  print(paste0("|---------- ",.x," ---------|"))
  print(moran.test(x, lw))
  
})
```

```{r}
coords <- data_set  |> 
  filter(populacao == "Aparecida D'Oeste/SP")  |>  
  select(longitude, latitude)

nb <- dnearneigh(as.matrix(coords), 5, 5100)  # ajuste dist√¢ncia
lw <- nb2listw(nb, style = "W")

walk(names_vari, ~{
  x <- data_set |> filter(populacao == "Aparecida D'Oeste/SP")|> pull(!!sym(.x))
  x[is.na(x)] <- mean(x,na.rm=TRUE) 
  print(paste0("|---------- ",.x," ---------|"))
  print(moran.test(x, lw))
  
})
```

### Modelagem geoestat√≠stica - Depend√™ncia Espacial
#### Listando Popula√ß√µes
```{r}
data_set$populacao |> unique()
```

#### Listando Vari√°veis
```{r}
data_set |> select(hc_m:s_enxofre) |> names()
```

#### Filtrando o banco de dados para an√°lise variogr√°fica
```{r}
pop <- "Selv√≠ria/MS"
variavel <- "dmc_m"
data_set_aux <- data_set |> 
  filter(
    populacao == pop) |> 
  select(longitude,latitude,variavel) |> 
  rename(x=longitude, y=latitude, z = !!sym(variavel)) |> 
  group_by(x,y) # |> mutate(z = log(z+1)) ## TRANSFORMAR SE NECESS√ÅRIO
glimpse(data_set_aux)
```

#### Criando objeto tipo sp e f√≥rmula para an√°lise 
```{r}
coordinates(data_set_aux) = ~ x + y  
form <- z ~ 1
```

#### Constru√ß√£o do Semivariograma Experimental
```{r}
vari_exp <- variogram(form, data = data_set_aux,
                      cressie = FALSE,
                      cutoff = 200, # dist√¢ncia m√°xima do semivariograma
                      width = 15) # dist√¢ncia entre pontos
vari_exp  |>  
 ggplot(aes(x=dist, y=gamma)) +
 geom_point() +
 labs(x="lag (m)",
      y=expression(paste(gamma,"(h)")))
```

#### Ajustando modelos

```{r}
patamar=10
alcance=40
epepita=1
modelo_1 <- fit.variogram(vari_exp,vgm(patamar,"Sph",alcance,epepita))
modelo_2 <- fit.variogram(vari_exp,vgm(patamar,"Exp",alcance,epepita))
modelo_3 <- fit.variogram(vari_exp,vgm(patamar,"Gau",alcance,epepita))
plot_my_models(modelo_1,modelo_2,modelo_3)
```

#### Escolha o melhor modelo (>r¬≤)
```{r}
modelo <- modelo_2
```

#### Salvando os par√¢metros ajustados
```{r}
model <- modelo |> slice(2) |> pull(model)
rss <- round(attr(modelo, "SSErr"),4)
c0 <- round(modelo$psill[[1]],4)
c0_c1 <- round(sum(modelo$psill),4)
a <- ifelse(model == "Gau", round(modelo$range[[2]]*(3^.5),2),
            ifelse(model == "Exp",round(3*modelo$range[[2]],2),
            round(modelo$range[[2]],2)))
r2 <- vari_exp |> add_column( model = model, a=a, c0 = c0,
                                  c0_c1 = c0_c1) |>
    mutate(
      gamma_m = ifelse(model == "Sph",
        ifelse(dist <= a, c0 + (c0_c1 - c0) * (3/2 * (dist/a) - 1/2 * (dist/a)^3),c0_c1), ifelse(model == "Exp", c0 + (c0_c1-c0)*(1-exp(-3*(dist/a))),c0 + (c0_c1-c0)*(1-exp(-(dist/a)^2)))),
      residuo_total = (gamma-mean(gamma))^2,
      residuo_mod = (gamma - gamma_m)^2
    ) |>
    summarise(
      r2=(sum(residuo_total) - sum(residuo_mod))/sum(residuo_total)
    ) |> pull(r2)

tibble(
  pop, variavel, model, c0, c0_c1, a, rss, r2
) |> mutate(gde = c0/c0_c1, .after = "a") |>
  write_csv(paste0("output/best-fit/",str_replace_all(pop,"/| ","_"),"-",variavel,".csv"))

ls_csv <- list.files("output/best-fit/",full.names = TRUE,pattern = ".csv")
map_df(ls_csv, read_csv) |>
  arrange(pop,variavel) |> 
  writexl::write_xlsx("output/semivariogram-model.xlsx")
```

#### Cluster hier√°rquico (intra-popula√ß√£o) - Lagoa Santa/GO



```{r}
arv_matriz <- data_set |> 
  filter(populacao == "Lagoa Santa/GO") |> 
  pull(arv_matriz)
da_pad<-decostand(data_set |> 
                    filter(populacao == "Lagoa Santa/GO") |> 
                    select(hc_m:s_enxofre) |> 
                    mutate(
                      eca_cm = ifelse(is.na(eca_cm),mean(eca_cm,na.rm=TRUE),eca_cm),
                      fruto = ifelse(is.na(fruto),mean(eca_cm,na.rm=TRUE),fruto)
                    ), 
                  method = "standardize",
                  na.rm=TRUE)
da_pad_solo <- da_pad |> select(mat_organica:s_enxofre)
da_pad_planta <- da_pad |> select(-(mat_organica:s_enxofre)) 
```


##### Atributos do Solo

```{r}
da_pad_euc<-vegdist(da_pad_solo,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- arv_matriz
plot(da_pad_euc_ward,
     ylab = "Dist√¢ncia Euclidiana",
     xlab = "Munic√≠pios",
     main = "",
     hang = -1,
     col = "black",
     lwd = 1.5,
     cex = .75,
     las = 1,
     axes = FALSE)
grupo_solo<-cutree(da_pad_euc_ward,3)
```


##### Atributos da Planta

```{r}
da_pad_euc<-vegdist(da_pad_planta,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- arv_matriz
plot(da_pad_euc_ward,
     ylab = "Dist√¢ncia Euclidiana",
     xlab = "Munic√≠pios",
     main = "",
     hang = -1,
     col = "black",
     lwd = 1.5,
     cex = .75,
     las = 1,
     axes = FALSE)
grupo_planta<-cutree(da_pad_euc_ward,3)
```


##### Solo + Planta

```{r}
da_pad_euc<-vegdist(da_pad,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- arv_matriz
plot(da_pad_euc_ward,
     ylab = "Dist√¢ncia Euclidiana",
     xlab = "Munic√≠pios",
     main = "",
     hang = -1,
     col = "black",
     lwd = 1.5,
     cex = .75,
     las = 1,
     axes = FALSE)
grupo_solo_planta <- cutree(da_pad_euc_ward,3)
```
### Compara√ß√£o dos grupos Espaciais

```{r}
df_aux <- data_set |> 
  filter(populacao == "Lagoa Santa/GO") |> 
  add_column(grupo_planta,grupo_solo,grupo_solo_planta)
df_aux |> 
  ggplot(aes(longitude, latitude,colour = as_factor(grupo_planta))) +
  geom_point(size=2) +
  theme_bw() + 
  labs(color = "Grupo-Planta") +
  scale_color_manual(values = c("#1B9E77","#D95F02","#7570B3")) +
  theme(
    legend.position = "top"
  )

df_aux |> 
  ggplot(aes(longitude, latitude,colour = as_factor(grupo_solo))) +
  geom_point(size=2) +
  theme_bw() + 
  labs(color = "Grupo-Solo") +
  scale_color_manual(values = c("#1B9E77","#D95F02","#7570B3")) +
    theme(
    legend.position = "top"
  )


df_aux |> 
  ggplot(aes(longitude, latitude,colour = as_factor(grupo_solo_planta))) +
  geom_point(size=2) +
  theme_bw() + 
  labs(color = "Grupo-Solo-Planta") +
  scale_color_manual(values = c("#1B9E77","#D95F02","#7570B3"))+
    theme(
    legend.position = "top"
  )

```


#### Cluster hier√°rquico (intra-popula√ß√£o) - Selv√≠ria/MS



```{r}
arv_matriz <- data_set |> 
  filter(populacao == "Selv√≠ria/MS") |> 
  pull(arv_matriz)
da_pad<-decostand(data_set |> 
                    filter(populacao == "Selv√≠ria/MS") |> 
                    select(hc_m:s_enxofre) |> 
                    mutate(
                      eca_cm = ifelse(is.na(eca_cm),mean(eca_cm,na.rm=TRUE),eca_cm),
                      fruto = ifelse(is.na(fruto),mean(eca_cm,na.rm=TRUE),fruto)
                    ), 
                  method = "standardize",
                  na.rm=TRUE)
da_pad_solo <- da_pad |> select(mat_organica:s_enxofre)
da_pad_planta <- da_pad |> select(-(mat_organica:s_enxofre)) 
```


##### Atributos do Solo

```{r}
da_pad_euc<-vegdist(da_pad_solo,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- arv_matriz
plot(da_pad_euc_ward,
     ylab = "Dist√¢ncia Euclidiana",
     xlab = "Munic√≠pios",
     main = "",
     hang = -1,
     col = "black",
     lwd = 1.5,
     cex = .75,
     las = 1,
     axes = FALSE)
grupo_solo<-cutree(da_pad_euc_ward,3)
```


##### Atributos da Planta

```{r}
da_pad_euc<-vegdist(da_pad_planta,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- arv_matriz
plot(da_pad_euc_ward,
     ylab = "Dist√¢ncia Euclidiana",
     xlab = "Munic√≠pios",
     main = "",
     hang = -1,
     col = "black",
     lwd = 1.5,
     cex = .75,
     las = 1,
     axes = FALSE)
grupo_planta<-cutree(da_pad_euc_ward,3)
```


##### Solo + Planta

```{r}
da_pad_euc<-vegdist(da_pad,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- arv_matriz
plot(da_pad_euc_ward,
     ylab = "Dist√¢ncia Euclidiana",
     xlab = "Munic√≠pios",
     main = "",
     hang = -1,
     col = "black",
     lwd = 1.5,
     cex = .75,
     las = 1,
     axes = FALSE)
grupo_solo_planta <- cutree(da_pad_euc_ward,3)
```
### Compara√ß√£o dos grupos Espaciais

```{r}
df_aux <- data_set |> 
  filter(populacao == "Selv√≠ria/MS") |> 
  add_column(grupo_planta,grupo_solo,grupo_solo_planta)
df_aux |> 
  ggplot(aes(longitude, latitude,colour = as_factor(grupo_planta))) +
  geom_point(size=2) +
  theme_bw() + 
  labs(color = "Grupo-Planta") +
  scale_color_manual(values = c("#1B9E77","#D95F02","#7570B3")) +
  theme(
    legend.position = "top"
  )

df_aux |> 
  ggplot(aes(longitude, latitude,colour = as_factor(grupo_solo))) +
  geom_point(size=2) +
  theme_bw() + 
  labs(color = "Grupo-Solo") +
  scale_color_manual(values = c("#1B9E77","#D95F02","#7570B3")) +
    theme(
    legend.position = "top"
  )


df_aux |> 
  ggplot(aes(longitude, latitude,colour = as_factor(grupo_solo_planta))) +
  geom_point(size=2) +
  theme_bw() + 
  labs(color = "Grupo-Solo-Planta") +
  scale_color_manual(values = c("#1B9E77","#D95F02","#7570B3"))+
    theme(
    legend.position = "top"
  )

```

#### Cluster hier√°rquico (intra-popula√ß√£o) - Aparecida D'Oeste/SP



```{r}
arv_matriz <- data_set |> 
  filter(populacao == "Aparecida D'Oeste/SP") |> 
  pull(arv_matriz)
da_pad<-decostand(data_set |> 
                    filter(populacao == "Aparecida D'Oeste/SP") |> 
                    select(hc_m:s_enxofre) |> 
                    mutate(
                      eca_cm = ifelse(is.na(eca_cm),mean(eca_cm,na.rm=TRUE),eca_cm),
                      fruto = ifelse(is.na(fruto),mean(eca_cm,na.rm=TRUE),fruto)
                    ), 
                  method = "standardize",
                  na.rm=TRUE)
da_pad_solo <- da_pad |> select(mat_organica:s_enxofre)
da_pad_planta <- da_pad |> select(-(mat_organica:s_enxofre)) 
```


##### Atributos do Solo

```{r}
da_pad_euc<-vegdist(da_pad_solo,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- arv_matriz
plot(da_pad_euc_ward,
     ylab = "Dist√¢ncia Euclidiana",
     xlab = "Munic√≠pios",
     main = "",
     hang = -1,
     col = "black",
     lwd = 1.5,
     cex = .75,
     las = 1,
     axes = FALSE)
grupo_solo<-cutree(da_pad_euc_ward,3)
```


##### Atributos da Planta

```{r}
da_pad_euc<-vegdist(da_pad_planta,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- arv_matriz
plot(da_pad_euc_ward,
     ylab = "Dist√¢ncia Euclidiana",
     xlab = "Munic√≠pios",
     main = "",
     hang = -1,
     col = "black",
     lwd = 1.5,
     cex = .75,
     las = 1,
     axes = FALSE)
grupo_planta<-cutree(da_pad_euc_ward,3)
```


##### Solo + Planta

```{r}
da_pad_euc<-vegdist(da_pad,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- arv_matriz
plot(da_pad_euc_ward,
     ylab = "Dist√¢ncia Euclidiana",
     xlab = "Munic√≠pios",
     main = "",
     hang = -1,
     col = "black",
     lwd = 1.5,
     cex = .75,
     las = 1,
     axes = FALSE)
grupo_solo_planta <- cutree(da_pad_euc_ward,3)
```
### Compara√ß√£o dos grupos Espaciais

```{r}
df_aux <- data_set |> 
  filter(populacao == "Aparecida D'Oeste/SP") |> 
  add_column(grupo_planta,grupo_solo,grupo_solo_planta)
df_aux |> 
  ggplot(aes(longitude, latitude,colour = as_factor(grupo_planta))) +
  geom_point(size=2) +
  theme_bw() + 
  labs(color = "Grupo-Planta") +
  scale_color_manual(values = c("#1B9E77","#D95F02","#7570B3")) +
  theme(
    legend.position = "top"
  )

df_aux |> 
  ggplot(aes(longitude, latitude,colour = as_factor(grupo_solo))) +
  geom_point(size=2) +
  theme_bw() + 
  labs(color = "Grupo-Solo") +
  scale_color_manual(values = c("#1B9E77","#D95F02","#7570B3")) +
    theme(
    legend.position = "top"
  )


df_aux |> 
  ggplot(aes(longitude, latitude,colour = as_factor(grupo_solo_planta))) +
  geom_point(size=2) +
  theme_bw() + 
  labs(color = "Grupo-Solo-Planta") +
  scale_color_manual(values = c("#1B9E77","#D95F02","#7570B3"))+
    theme(
    legend.position = "top"
  )

```
#### An√°lise de Componentes Principais - Lagoa Santa/GO

```{r}
arv_matriz <- data_set |> 
  filter(populacao == "Lagoa Santa/GO") |> 
  pull(arv_matriz)
da_pad<-decostand(data_set |> 
                    filter(populacao == "Lagoa Santa/GO") |> 
                    select(hc_m:s_enxofre) |> 
                    mutate(
                      eca_cm = ifelse(is.na(eca_cm),mean(eca_cm,na.rm=TRUE),eca_cm),
                      fruto = ifelse(is.na(fruto),mean(eca_cm,na.rm=TRUE),fruto)
                    ), 
                  method = "standardize",
                  na.rm=TRUE)
da_pad_euc<-vegdist(da_pad,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- arv_matriz
grupo_solo_planta <- cutree(da_pad_euc_ward,3)
print("======== An√°lise de Componentes Principais ========== ")
pca <-  prcomp(da_pad,scale.=TRUE)
# Autovalores
eig<-pca$sdev^2
print("==== Autovalores ====")
print(round(eig,3))
print("==== % da vari√¢ncia explicada ====")
ve<-eig/sum(eig)
print(round(ve,4))
print("==== % da vari√¢ncia explicada acumulada ====")
print(round(cumsum(ve),4)*100)
print("==== Poder Discriminante ====")
mcor<-cor(da_pad,pca$x)
corrplot(mcor)
print("==== screeplot ====")
screeplot(pca)
abline(h=1)
```

```{r}
pc1V<-cor(da_pad,pca$x)[,1]/sd(cor(da_pad,pca$x)[,1])
pc2V<-cor(da_pad,pca$x)[,2]/sd(cor(da_pad,pca$x)[,2])
pc3V<-cor(da_pad,pca$x)[,3]/sd(cor(da_pad,pca$x)[,3])
pc1c<-pca$x[,1]/sd(pca$x[,1])
pc2c<-pca$x[,2]/sd(pca$x[,2])
pc3c<-pca$x[,3]/sd(pca$x[,3])
nv<-ncol(da_pad) # n√∫mero de vari√°veis utilizadas na an√°lise
```

```{r}
mc <- cor(da_pad)
# gr√°fico biplot
bip<-data.frame(pc1c,pc2c,pc3c,grupo_solo_planta)
texto <- data.frame(
  x = pc1V,
  y = pc2V,
  z = pc3V,
  label = rownames(mc)
)

bi_plot <- bip |> 
  ggplot(aes(x=pc1c,y=pc2c,color = as_factor(grupo_solo_planta)))+
  geom_point(size = 1) + 
  theme_minimal() +
  # scale_shape_manual(values=16:18)+
  scale_color_manual(values=c("#009E73", "#999999","#D55E00")) +
  #annotate(geom="text", x=pc1V, y=pc2V, label=names(pc1V),
  #            color="black",font=3)+
  geom_vline(aes(xintercept=0),
             color="black", size=1)+
  geom_hline(aes(yintercept=0),
             color="black", size=1)+
  annotate(geom="segment",
           x=rep(0,length(da_pad)),
           xend=texto$x,
           y=rep(0,length(da_pad)),
           yend=texto$y,color="black",lwd=.5)+
  geom_label(data=texto,aes(x=x,y=y,label=label),
             color="black",angle=0,fontface="bold",size=4,fill="white")+
  labs(x=paste("CP1 (",round(100*ve[1],2),"%)",sep=""),
       y=paste("CP2 (",round(100*ve[2],2),"%)",sep=""),
       color="",shape="")+
  theme(legend.position = "top") +
  xlim(-3,3)
bi_plot
```


```{r}
    print("==== Tabela da correla√ß√£o dos atributos com cada PC ====")
    ck<-sum(pca$sdev^2>=0.98)
    tabelapca<-vector()
    for( l in 1:ck) tabelapca<-cbind(tabelapca,mcor[,l])
    colnames(tabelapca)<-paste(rep(c("PC"),ck),1:ck,sep="")
    pcat<-round(tabelapca,3)
    tabelapca<-tabelapca[order(abs(tabelapca[,1])),]
    print(tabelapca)

```

#### An√°lise de Componentes Principais - Selv√≠ria/MS

```{r}
arv_matriz <- data_set |> 
  filter(populacao == "Selv√≠ria/MS") |> 
  pull(arv_matriz)
da_pad<-decostand(data_set |> 
                    filter(populacao == "Selv√≠ria/MS") |> 
                    select(hc_m:s_enxofre) |> 
                    mutate(
                      eca_cm = ifelse(is.na(eca_cm),mean(eca_cm,na.rm=TRUE),eca_cm),
                      fruto = ifelse(is.na(fruto),mean(eca_cm,na.rm=TRUE),fruto)
                    ), 
                  method = "standardize",
                  na.rm=TRUE)
da_pad_euc<-vegdist(da_pad,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- arv_matriz
grupo_solo_planta <- cutree(da_pad_euc_ward,3)
print("======== An√°lise de Componentes Principais ========== ")
pca <-  prcomp(da_pad,scale.=TRUE)
# Autovalores
eig<-pca$sdev^2
print("==== Autovalores ====")
print(round(eig,3))
print("==== % da vari√¢ncia explicada ====")
ve<-eig/sum(eig)
print(round(ve,4))
print("==== % da vari√¢ncia explicada acumulada ====")
print(round(cumsum(ve),4)*100)
print("==== Poder Discriminante ====")
mcor<-cor(da_pad,pca$x)
corrplot(mcor)
print("==== screeplot ====")
screeplot(pca)
abline(h=1)
```

```{r}
pc1V<-cor(da_pad,pca$x)[,1]/sd(cor(da_pad,pca$x)[,1])
pc2V<-cor(da_pad,pca$x)[,2]/sd(cor(da_pad,pca$x)[,2])
pc3V<-cor(da_pad,pca$x)[,3]/sd(cor(da_pad,pca$x)[,3])
pc1c<-pca$x[,1]/sd(pca$x[,1])
pc2c<-pca$x[,2]/sd(pca$x[,2])
pc3c<-pca$x[,3]/sd(pca$x[,3])
nv<-ncol(da_pad) # n√∫mero de vari√°veis utilizadas na an√°lise
```

```{r}
mc <- cor(da_pad)
# gr√°fico biplot
bip<-data.frame(pc1c,pc2c,pc3c,grupo_solo_planta)
texto <- data.frame(
  x = pc1V,
  y = pc2V,
  z = pc3V,
  label = rownames(mc)
)

bi_plot <- bip |> 
  ggplot(aes(x=pc1c,y=pc2c,color = as_factor(grupo_solo_planta)))+
  geom_point(size = 1) + 
  theme_minimal() +
  # scale_shape_manual(values=16:18)+
  scale_color_manual(values=c("#009E73", "#999999","#D55E00")) +
  #annotate(geom="text", x=pc1V, y=pc2V, label=names(pc1V),
  #            color="black",font=3)+
  geom_vline(aes(xintercept=0),
             color="black", size=1)+
  geom_hline(aes(yintercept=0),
             color="black", size=1)+
  annotate(geom="segment",
           x=rep(0,length(da_pad)),
           xend=texto$x,
           y=rep(0,length(da_pad)),
           yend=texto$y,color="black",lwd=.5)+
  geom_label(data=texto,aes(x=x,y=y,label=label),
             color="black",angle=0,fontface="bold",size=4,fill="white")+
  labs(x=paste("CP1 (",round(100*ve[1],2),"%)",sep=""),
       y=paste("CP2 (",round(100*ve[2],2),"%)",sep=""),
       color="",shape="")+
  theme(legend.position = "top") +
  xlim(-3,3)
bi_plot
```

```{r}
    print("==== Tabela da correla√ß√£o dos atributos com cada PC ====")
    ck<-sum(pca$sdev^2>=0.98)
    tabelapca<-vector()
    for( l in 1:ck) tabelapca<-cbind(tabelapca,mcor[,l])
    colnames(tabelapca)<-paste(rep(c("PC"),ck),1:ck,sep="")
    pcat<-round(tabelapca,3)
    tabelapca<-tabelapca[order(abs(tabelapca[,1])),]
    print(tabelapca)

```

#### An√°lise de Componentes Principais - Aparecida D'Oeste/SP

```{r}
arv_matriz <- data_set |> 
  filter(populacao == "Aparecida D'Oeste/SP") |> 
  pull(arv_matriz)
da_pad<-decostand(data_set |> 
                    filter(populacao == "Aparecida D'Oeste/SP") |> 
                    select(hc_m:s_enxofre) |> 
                    mutate(
                      eca_cm = ifelse(is.na(eca_cm),mean(eca_cm,na.rm=TRUE),eca_cm),
                      fruto = ifelse(is.na(fruto),mean(eca_cm,na.rm=TRUE),fruto)
                    ), 
                  method = "standardize",
                  na.rm=TRUE)
da_pad_euc<-vegdist(da_pad,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- arv_matriz
grupo_solo_planta <- cutree(da_pad_euc_ward,3)
print("======== An√°lise de Componentes Principais ========== ")
pca <-  prcomp(da_pad,scale.=TRUE)
# Autovalores
eig<-pca$sdev^2
print("==== Autovalores ====")
print(round(eig,3))
print("==== % da vari√¢ncia explicada ====")
ve<-eig/sum(eig)
print(round(ve,4))
print("==== % da vari√¢ncia explicada acumulada ====")
print(round(cumsum(ve),4)*100)
print("==== Poder Discriminante ====")
mcor<-cor(da_pad,pca$x)
corrplot(mcor)
print("==== screeplot ====")
screeplot(pca)
abline(h=1)
```

```{r}
pc1V<-cor(da_pad,pca$x)[,1]/sd(cor(da_pad,pca$x)[,1])
pc2V<-cor(da_pad,pca$x)[,2]/sd(cor(da_pad,pca$x)[,2])
pc3V<-cor(da_pad,pca$x)[,3]/sd(cor(da_pad,pca$x)[,3])
pc1c<-pca$x[,1]/sd(pca$x[,1])
pc2c<-pca$x[,2]/sd(pca$x[,2])
pc3c<-pca$x[,3]/sd(pca$x[,3])
nv<-ncol(da_pad) # n√∫mero de vari√°veis utilizadas na an√°lise
```

```{r}
mc <- cor(da_pad)
# gr√°fico biplot
bip<-data.frame(pc1c,pc2c,pc3c,grupo_solo_planta)
texto <- data.frame(
  x = pc1V,
  y = pc2V,
  z = pc3V,
  label = rownames(mc)
)

bi_plot <- bip |> 
  ggplot(aes(x=pc1c,y=pc2c,color = as_factor(grupo_solo_planta)))+
  geom_point(size = 1) + 
  theme_minimal() +
  # scale_shape_manual(values=16:18)+
  scale_color_manual(values=c("#009E73", "#999999","#D55E00")) +
  #annotate(geom="text", x=pc1V, y=pc2V, label=names(pc1V),
  #            color="black",font=3)+
  geom_vline(aes(xintercept=0),
             color="black", size=1)+
  geom_hline(aes(yintercept=0),
             color="black", size=1)+
  annotate(geom="segment",
           x=rep(0,length(da_pad)),
           xend=texto$x,
           y=rep(0,length(da_pad)),
           yend=texto$y,color="black",lwd=.5)+
  geom_label(data=texto,aes(x=x,y=y,label=label),
             color="black",angle=0,fontface="bold",size=4,fill="white")+
  labs(x=paste("CP1 (",round(100*ve[1],2),"%)",sep=""),
       y=paste("CP2 (",round(100*ve[2],2),"%)",sep=""),
       color="",shape="")+
  theme(legend.position = "top") +
  xlim(-3,3)
bi_plot
```


```{r}
    print("==== Tabela da correla√ß√£o dos atributos com cada PC ====")
    ck<-sum(pca$sdev^2>=0.98)
    tabelapca<-vector()
    for( l in 1:ck) tabelapca<-cbind(tabelapca,mcor[,l])
    colnames(tabelapca)<-paste(rep(c("PC"),ck),1:ck,sep="")
    pcat<-round(tabelapca,3)
    tabelapca<-tabelapca[order(abs(tabelapca[,1])),]
    print(tabelapca)

```

